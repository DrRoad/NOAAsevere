Economic and Population Health Effects of Severe Storms 
=============
## (United States, 1950-2011)


The raw data and documentation can be found and downloaded by running the following code:
```{r download}
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", "StormData.csv.bz2")
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf", "StormDocumentation.pdf")
```
Then the data can be loaded in R as follows.  NOTE: you will need the R.utils package, which can be installed through CRAN.
```{r load}
library(R.utils)
bunzip2("StormData.csv.bz2")
stormData <- read.csv("StormData.csv")
```

The BGN_DATE column is a factor variable.  We will convert it to an object of class "Date" and put them in ascending order.
```{r date}
stormData$BGN_DATE <- as.character(stormData$BGN_DATE)
stormData$BGN_DATE <- as.Date(stormData$BGN_DATE, "%m/%d/%Y")
stormData <- stormData[order(stormData$BGN_DATE),]
```

After doing this, we can create the following histogram which shows the numbers of severe weather events contained in the data for each year.
```{r yearhist}
hist(stormData$BGN_DATE[1:300000], breaks = 40, freq= TRUE, main = "Severe Weather Events Reported Per Year", xlab = "Year", ylab="Number of Events Reported", ylim=c(0,6000))
```

From this we can see that the number of events reported in this data set rises sharply beginning in the mid 1970's.  For this reason, we will subset the data to include only those reports from 1975 and later.  This will give us a more accurate picture because it will filter out data from the earlier years when reporting was much more scattered and therefore cannot be counted on to be fully representitive.
```{r se}
sf <- grep("1975", stormData$BGN_DATE)
sf[1]
dim(stormData)
sd <- stormData[54960:902297,]
```
```{r sdheadtail}
head(sd[,1:5])
tail(sd[,1:5])
```

For this analysis, we will be examining what types of severe weather events caused the most damage.  Unfortunately, the `EVTYPE` variable is rather messy.  We will clean it up by adding another variable called `event` and putting broader, more useful, labels for each event into that variable.
```{r event}
levels(sd$EVTYPE) <- tolower(levels(sd$EVTYPE))
sd$event <- "other"
sd$event[grep("lightning", sd$EVTYPE)] <- "lightning"
sd$event[grep("thunder|rain", sd$EVTYPE)] <- "heavy rain"
sd$event[grep("snow|blizzard|chill|wint|cold|sleet|ice|freez", sd$EVTYPE)] <- "winter storm"
sd$event[grep("hail", sd$EVTYPE)] <- "hail"
sd$event[grep("seas|surf|tide|swell", sd$EVTYPE)] <- "rough seas"
sd$event[grep("tornado|gustnado|funnel|spout", sd$EVTYPE)] <- "tornado"
sd$event[grep("fire|smoke", sd$EVTYPE)] <- "fire"
sd$event[grep("wind", sd$EVTYPE)] <- "heavy wind"
sd$event[grep("hurricane", sd$EVTYPE)] <- "hurricane"
sd$event[grep("volcan", sd$EVTYPE)] <- "volcano"
sd$event[grep("flood|stream", sd$EVTYPE)] <- "flood"
sd$event[grep("heat|temp|hot", sd$EVTYPE)] <- "heat wave"
sd$event[grep("dry|drought", sd$EVTYPE)] <- "drought"
sd$event[grep("microburst", sd$EVTYPE)] <- "microburst"
sd$event[grep("hurricane", sd$EVTYPE)] <- "hurricane"
sd$event <- as.factor(sd$event)
```

By looking at the column names of our `sd`, and consulting the documentation provided, we can conclude that the columns related to property damage are 25 through 28 and those related to population health are 23 and 24.
```{r names}
names(sd)
```

We will then create two data sets, subsetting out those two groups, as well as our recently created `event` variable.

```{r sdpsdh}
sdp <- sd[, c(2, 25:28, 38)]
sdh <- sd[, c(2, 23, 24, 38)]
```

The `sdh` data set is now fairly straight-forward.  

However, the `sdp` set is a bit confusing.  We have to do some cleaning before we can calculate the Crop Damage and Property Damage properly.  We learn from the page 12 of the documentation that the `DMG` variables represent US Dollar amounts rounded to three significant digits and that the `EXP` variables should contain either "K", "M", or "B" to signify the order of magnitude of the number being "thousand", "million", or "billion" respectively.  However, by doing a summary of those variables, we note that there are a number of other values as well.

``` {r summaryexp}
summary(sdp$CROPDMGEXP)
summary(sdp$PROPDMGEXP)
```

None of these values are mentioned in the documentation.  However, we notice that none of the other values are present in even 0.01% of the rows.  This fact, coupled with their lack of explanation in the documentation, leads us to decide that they are misleading and statistically insignificant, so we will purge them from the data set.  The following code does this, after first transforming all letter characters to capitals for ease of processing.
```{r purge}
sdp$CROPDMGEXP <- toupper(as.character(sdp$CROPDMGEXP))
sdp$PROPDMGEXP <- toupper(as.character(sdp$PROPDMGEXP))
sdp <- sdp[-grep("[^K|M|B]", sdp$CROPDMGEXP),]
sdp <- sdp[-grep("[^K|M|B]", sdp$PROPDMGEXP),]
```

Now that the unsavory factors have eliminated, and all of the remaining characters in the `EXP` columns have been converted to upper case, we can calculate the actual damage amounts in US Dollars.

```{r dollars}
sdp$propmult <- 1
sdp$propmult[sdp$PROPDMGEXP == "K"] <- 1000
sdp$propmult[sdp$PROPDMGEXP == "M"] <- 1000000
sdp$propmult[sdp$PROPDMGEXP == "B"] <- 1000000000
sdp$PROPDMG <- sdp$PROPDMG*sdp$propmult
sdp$cropmult <- 1
sdp$cropmult[sdp$CROPDMGEXP == "K"] <- 1000
sdp$cropmult[sdp$CROPDMGEXP == "M"] <- 1000000
sdp$cropmult[sdp$CROPDMGEXP == "B"] <- 1000000000
sdp$CROPDMG <- sdp$CROPDMG*sdp$cropmult
```

Finally we will combine `PROPDMG` and `CROPDMG` into a variable called `totaldmg` which we will use to compare different event types' economic damge.  

```{r totaldmg}
sdp$totaldmg <- sdp$CROPDMG+sdp$PROPDMG
```

Before we go any further, we will check the `totaldmg` variable to make sure we don't have any unexplained outliers.  We do this looking at the Top 10 `totaldmg` events make sure they all seem realistic.
```{r top10}
sdpo <- sdp
sdpo <- sdpo[order(sdpo$totaldmg, decreasing=TRUE),]
top10 <- sdpo[1:10,]
top10
```

Unfortunately, things seem strange.  There is one event - on January 1, 2006 - that registers over $115 Billion in damage.  This seems unlikely, especially when we rack our memories and can't remember any catastrophic weather events happening on New Year's Day less than 10 years ago. 

We go back to the `sd` data set which still has a `REMARKS` variable, to see if we can learn anything.
```{r napa}
Napa <- sd[sd$BGN_DATE == "2006-01-01",]
Napa <- Napa[23,]
Napa[,c(25:28, 36)]
```

And here is the event: a flood in Napa, CA.  From the remarks, we can see that it did "at least $70 million" in property damage.  This is significant, but nowhere near the $115 Billion which is reflected in the `PROPDMG` AND `PROPDMGEXP` variables.  We have to assume that this was a typo, the most likely situation being that someone typed a "B" instead of an "M" in the `CROPDMGEXP` column.  This is fixed with the code below and we move on.
```{r napafix}
sdp$totaldmg[sdp$totaldmg==115032500000] <- 115032500
```



Now that everything is all cleaned up, we create a new object `sdpa` which aggregates the total damage for each type of event that we have defined in our `event` variable.

```{r spda}
sdpa <- sdp[,c("event", "totaldmg")]
sdpa <- aggregate(sdpa$totaldmg, list(sdpa$event), sum)
colnames(sdpa) <- c("event", "totaldmg")
```


---

pdh, combine and multiply injuries

---

Now that we have our shit together...
